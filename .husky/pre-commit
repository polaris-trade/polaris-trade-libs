#!/usr/bin/env sh

echo "ðŸ”§ Auto-formatting code..."
cargo fmt --all

echo "ðŸ“¦ Sorting Cargo.toml dependencies..."
# Find and format all Cargo.toml files
find . -name "Cargo.toml" -not -path "./target/*" -exec sh -c '
  if command -v cargo-sort >/dev/null 2>&1; then
    cargo sort --workspace --grouped "{}"
  else
    echo "âš ï¸  cargo-sort not installed, skipping dependency sorting"
    echo "   Install with: cargo install cargo-sort"
  fi
' \;

# Stage formatted files
git add -u

echo "âœ… Code formatted and staged"

echo "ðŸ“‹ Running clippy..."
cargo make clippy || {
  echo "âŒ Clippy failed."
  exit 1
}

# Optimized build and test
echo "ðŸ”¨ Building..."
export RUSTFLAGS="-C codegen-units=16 -C debuginfo=0"
cargo build --profile ci >/dev/null 2>&1 || { echo "âŒ Build failed!"; cargo build --profile ci; exit 1; }

echo "ðŸ§ª Running tests..."
cargo nextest run --profile ci 2>&1 | grep -v "^\s*Compiling\|^\s*Finished\|^\s*Running" || cargo test --quiet || exit 1

echo "âœ… All checks passed!"
