# Build and test code across platforms
name: CI - Build & Test

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 1
  RUST_BACKTRACE: 1
  RUSTFLAGS: "-C codegen-units=16 -C debuginfo=0"

jobs:
  check-release:
    name: Check Release Merge
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ github.event.head_commit.message }}" =~ ^chore\(main\):\ release ]]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "⏭️ Skipping coverage for release-please commit on main"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi

  format:
    name: Check Formatting
    runs-on: ubuntu-latest
    needs: check-release
    if: needs.check-release.outputs.should_skip != 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  test:
    name: "Test - OS: ${{ matrix.os }}; Rust: ${{ matrix.rust }}"
    runs-on: ${{ matrix.os }}
    needs: format
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust:
          - stable # Latest stable
          - 1.90.0 # MSRV-1
          - 1.89.0 # MSRV-2
          - 1.88.0 # MSRV-3
          - nightly # Latest nightly
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust ${{ matrix.rust }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: clippy

      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            libelf-dev \
            zlib1g-dev \
            cmake \
            lld

      - name: Install build dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install llvm

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.4

      - name: Rust Cache (Optimized)
        uses: Swatinem/rust-cache@v2
        with:
          cache-targets: true
          cache-all-crates: true
          key: ${{ matrix.rust }}-${{ matrix.os }}

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
      - name: Build (optimized)
        run: cargo build --profile ci
      - name: Test (parallel)
        run: |
          cargo install cargo-nextest
          cargo nextest run --profile ci
      # - name: Build examples
      #   run: |
      #     cargo build --examples --profile ci
      #     cargo run --example simple_usage
      #     cargo run --example configuration
      - name: Show cache stats
        run: sccache --show-stats

  build:
    name: "Build - OS: ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    needs: format
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install fast linker (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          if [ "$RUNNER_OS" = "Linux" ]; then
            sudo apt-get update && \
            sudo apt-get install -y \
              build-essential \
              pkg-config \
              libssl-dev \
              libelf-dev \
              zlib1g-dev \
              cmake \
              lld
          elif [ "$RUNNER_OS" = "macOS" ]; then
            brew install llvm
          fi
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.4
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-targets: true
      - name: Build (optimized)
        run: cargo build --profile ci
        env:
          CARGO_INCREMENTAL: 1
          RUSTFLAGS: "-C codegen-units=16 -C debuginfo=0"

  ci-status:
    name: CI - Build & Test
    runs-on: ubuntu-latest
    needs:
      - format
      - test
      - build
    if: |
      always() &&
      needs.format.result == 'success' &&
      needs.test.result == 'success' &&
      needs.build.result == 'success'
    steps:
      - run: echo "All checks passed"
